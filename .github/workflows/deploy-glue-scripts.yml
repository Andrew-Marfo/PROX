name: Deploy Glue Scripts to S3

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  SCRIPTS: |
    bronze_ingestion_script.py,bronze,/scripts/bronze_ingestion_script.py
    transformations_script.py,bronze,/scripts/transformations_script.py
    gold_data_curation_script.py,gold,/scripts/gold_data_curation_script.py
    s3_to_redshift_script.py,gold,/scripts/s3_to_redshift_script.py

jobs:
  deploy-glue-scripts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{    secrets.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      - name: Get bronze bucket name
        id: bronze_bucket
        run: echo "value=$(terraform output -raw bronze_bucket_name)" >> $GITHUB_OUTPUT

      - name: Get silver bucket name
        id: silver_bucket
        run: echo "value=$(terraform output -raw silver_bucket_name)" >> $GITHUB_OUTPUT

      - name: Get gold bucket name
        id: gold_bucket
        run: echo "value=$(terraform output -raw gold_bucket_name)" >> $GITHUB_OUTPUT

      - name: Deploy Glue scripts to S3
        run: |
          echo "$SCRIPTS" | while IFS="," read -r LOCAL BUCKET REMOTE; do
            if [ "$BUCKET" = "bronze" ]; then
              BUCKET_NAME="${{ steps.bronze_bucket.outputs.value }}"
            elif [ "$BUCKET" = "silver" ]; then
              BUCKET_NAME="${{ steps.silver_bucket.outputs.value }}"
            elif [ "$BUCKET" = "gold" ]; then
              BUCKET_NAME="${{ steps.gold_bucket.outputs.value }}"
            else
              echo "‚ùå Unknown bucket: $BUCKET"
              exit 1
            fi
            echo "Uploading $LOCAL to s3://$BUCKET_NAME$REMOTE"
            aws s3 cp "glue_scripts/$LOCAL" "s3://$BUCKET_NAME$REMOTE" --only-show-errors || exit 1
          done

      - name: Done
        run: echo "üéâ Glue scripts deployed successfully!"